<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta Avanzada de Balanceo de Líneas de Producción</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; color: #1a202c; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); padding: 1.5rem; transition: all 0.3s ease-in-out; }
        .card:hover { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
        .card-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: #2d3748; padding-bottom: 1rem; border-bottom: 2px solid #e2e8f0; }
        .label-input { display: block; font-size: 0.875rem; font-weight: 600; color: #4a5568; margin-bottom: 0.375rem; }
        .input-field { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid #cbd5e0; border-radius: 0.375rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.075); transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; background-color: #fdfdfe; }
        .input-field:focus { outline: none; border-color: #4299e1; box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2); background-color: white; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; text-align: center; cursor: pointer; border: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn i { margin-right: 0.5rem; }
        .btn-primary { background-color: #4299e1; color: white; }
        .btn-primary:hover { background-color: #3182ce; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(66,153,225,0.2); }
        .btn-secondary { background-color: #718096; color: white; }
        .btn-secondary:hover { background-color: #4a5568; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(113,128,150,0.2); }
        .btn-success { background-color: #48bb78; color: white; }
        .btn-success:hover { background-color: #38a169; }
        .btn-danger { background-color: #f56565; color: white; }
        .btn-danger:hover { background-color: #e53e3e; }
        .results-area { margin-top: 1.5rem; padding: 1.25rem; background-color: #f7fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; white-space: pre-wrap; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 0.9rem; max-height: 450px; overflow-y: auto; line-height: 1.6; color: #2d3748; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: white; margin: 8% auto; padding: 2.5rem; border-radius: 0.5rem; width: 90%; max-width: 600px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); animation: slideInUp 0.4s ease-out; }
        .modal-header { font-size: 1.5rem; font-weight: 600; color: #2d3748; margin-bottom: 1rem; }
        .modal-body { margin-bottom: 1.5rem; color: #4a5568; line-height: 1.6; }
        .chart-container { margin-top: 2rem; padding: 1.5rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; background-color: #fff; }
        .chart-container img { max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 0.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 1.5rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; }
        th, td { border-bottom: 1px solid #e2e8f0; padding: 0.875rem 1rem; text-align: left; font-size: 0.875rem; }
        td:last-child, th:last-child { border-right: 0; }
        th { background-color: #f7fafc; font-weight: 600; color: #2d3748; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: 0; }
        tr:hover td { background-color: #f0f2f5; }
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #2d3748; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.4; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #2d3748 transparent transparent transparent; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .tab-button { padding: 0.75rem 1.5rem; cursor: pointer; background-color: #e2e8f0; border: none; border-bottom: 3px solid transparent; font-weight: 500; color: #4a5568; }
        .tab-button.active { background-color: #fff; border-bottom: 3px solid #4299e1; color: #2d3748; font-weight: 600; }
        .tab-content { display: none; padding-top:1.5rem; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-7xl">
        <header class="mb-10 text-center">
            <div class="inline-flex items-center justify-center bg-gradient-to-r from-blue-500 to-indigo-600 p-3 rounded-lg shadow-lg mb-4">
                 <i class="fas fa-cogs text-white text-3xl"></i>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Optimización de Líneas de Producción</h1>
            <p class="text-lg text-gray-600 mt-2">Herramienta avanzada para el análisis y balanceo eficiente de sus procesos productivos.</p>
        </header>

        <div id="infoModal" class="modal">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="modal-header p-0 border-b-0">Información</h3>
                    <button onclick="closeModal('infoModal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="modalMessage" class="modal-body"></div>
                <div class="mt-6 text-right">
                    <button onclick="closeModal('infoModal')" class="btn btn-primary"><i class="fas fa-check"></i>Aceptar</button>
                </div>
            </div>
        </div>
        
        <div id="loadingModal" class="modal">
            <div class="modal-content text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto mb-4"></div>
                <h3 id="loadingModalTitle" class="modal-header p-0 border-b-0 text-xl">Procesando...</h3>
                <p id="loadingModalMessage" class="modal-body">Realizando cálculos, por favor espere.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="card">
                    <h2 class="card-header">
                        <i class="fas fa-sliders-h mr-2"></i>1. Parámetros Globales
                        <span class="tooltip ml-2">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span class="tooltiptext">Define las unidades a producir, los empleados disponibles y el número de estaciones de trabajo. Estos valores son cruciales para los cálculos de eficiencia y asignación.</span>
                        </span>
                    </h2>
                    <form id="paramsForm" class="space-y-4">
                        <div>
                            <label for="unidadesProducir" class="label-input">Unidades a Producir:</label>
                            <input type="number" id="unidadesProducir" value="100" min="0" class="input-field">
                        </div>
                        <div>
                            <label for="empleadosDisponibles" class="label-input">Empleados Disponibles:</label>
                            <input type="number" id="empleadosDisponibles" value="5" min="0" class="input-field">
                        </div>
                        <div>
                            <label for="numEstaciones" class="label-input">Número de Estaciones:</label>
                            <input type="number" id="numEstaciones" value="3" min="1" class="input-field">
                        </div>
                        <button type="button" id="btnGenerarCamposEstaciones" class="btn btn-secondary w-full mt-2"><i class="fas fa-plus-circle"></i>Generar Campos de Estaciones</button>
                    </form>
                </div>

                <div class="card">
                    <h2 class="card-header">
                        <i class="fas fa-tasks mr-2"></i>2. Configuración de Estaciones
                         <span class="tooltip ml-2">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span class="tooltiptext">Para cada estación, asigna un nombre único, el tiempo de proceso en minutos y, opcionalmente, el nombre de la estación predecesora directa. La correcta definición de predecesoras es vital para el cálculo de la ruta crítica (CPM). **Importante: Ingrese solo UN nombre de estación en el campo 'Predecesora'.**</span>
                        </span>
                    </h2>
                    <div id="estacionesInputContainer" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-sm">Define el número de estaciones y presiona "Generar Campos" para empezar.</p>
                    </div>
                </div>
                 <div class="card">
                    <h2 class="card-header">
                        <i class="fas fa-question-circle mr-2"></i>Guía Rápida
                    </h2>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-2">
                        <li><strong>Parámetros Globales:</strong> Ingresa la cantidad de unidades, empleados y el total de estaciones.</li>
                        <li><strong>Configuración de Estaciones:</strong>
                            <ul>
                                <li><i class="fas fa-caret-right"></i> <strong>Nombre:</strong> Identificador único para cada estación (ej: "Corte", "Ensamblaje A").</li>
                                <li><i class="fas fa-caret-right"></i> <strong>Tiempo:</strong> Duración de la tarea en esa estación (en minutos, positivo).</li>
                                <li><i class="fas fa-caret-right"></i> <strong>Predecesora:</strong> Nombre de la estación que DEBE finalizar antes de que esta pueda comenzar. Deja en blanco si no tiene o es la primera. **Solo un nombre.**</li>
                            </ul>
                        </li>
                        <li><strong>Calcular:</strong> Una vez ingresados todos los datos, presiona "Calcular Balanceo".</li>
                        <li><strong>Resultados:</strong> Analiza las métricas, la ruta crítica, gráficos y recomendaciones.</li>
                        <li><strong>Exportar:</strong> Genera reportes en TXT o PDF.</li>
                    </ul>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="card">
                    <h2 class="card-header"><i class="fas fa-cogs mr-2"></i>3. Acciones y Resultados</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <button type="button" id="btnCalcularBalanceo" class="btn btn-primary w-full col-span-1 sm:col-span-3"><i class="fas fa-calculator"></i>Calcular Balanceo</button>
                        <button type="button" id="btnExportarTXT" class="btn btn-success w-full hidden"><i class="fas fa-file-alt"></i>Exportar a TXT</button>
                        <button type="button" id="btnExportarPDF" class="btn btn-danger w-full hidden"><i class="fas fa-file-pdf"></i>Exportar a PDF</button>
                    </div>

                    <div id="resultadosContainer" class="mt-6 hidden">
                        <div class="mb-6 border-b border-gray-200">
                            <nav class="flex -mb-px" aria-label="Tabs">
                                <button class="tab-button active" data-tab="analisisTab"><i class="fas fa-chart-line mr-2"></i>Análisis y Métricas</button>
                                <button class="tab-button" data-tab="cpmTab"><i class="fas fa-project-diagram mr-2"></i>Detalle CPM</button>
                                <button class="tab-button" data-tab="graficosTab"><i class="fas fa-chart-pie mr-2"></i>Gráficos</button>
                            </nav>
                        </div>

                        <div id="analisisTab" class="tab-content active">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Análisis de Resultados y Recomendaciones:</h3>
                            <div id="textoResultados" class="results-area">Presiona "Calcular Balanceo" para ver los resultados.</div>
                        </div>

                        <div id="cpmTab" class="tab-content">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Detalle de Estaciones (CPM):
                                <span class="tooltip ml-1">
                                    <i class="fas fa-info-circle text-blue-500 text-sm"></i>
                                    <span class="tooltiptext">ES: Inicio Más Temprano, EF: Fin Más Temprano, LS: Inicio Más Tardío, LF: Fin Más Tardío, Holgura: Tiempo que puede retrasarse una tarea sin afectar el proyecto. Estaciones críticas tienen holgura cero.</span>
                                </span>
                            </h3>
                            <div id="tablaCPMContainer" class="overflow-x-auto">
                                <table id="tablaCPM">
                                    <thead>
                                        <tr>
                                            <th>Estación</th><th>Tiempo</th><th>ES</th><th>EF</th>
                                            <th>LS</th><th>LF</th><th>Holgura</th><th>Crítica</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaCPMBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="graficosTab" class="tab-content">
                             <h3 class="text-xl font-semibold mb-3 text-gray-700">Visualización Gráfica:</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div id="graficoPieContainer" class="chart-container hidden">
                                    <h4 class="text-lg font-semibold mb-3 text-center">Distribución del Tiempo por Estación</h4>
                                    <img id="imgGraficoPie" src="#" alt="Gráfico de Pastel de Tiempos de Estación">
                                </div>
                                <div id="graficoBarrasContainer" class="chart-container hidden">
                                    <h4 class="text-lg font-semibold mb-3 text-center">Asignación de Empleados</h4>
                                    <img id="imgGraficoBarras" src="#" alt="Gráfico de Barras de Asignación de Empleados">
                                </div>
                            </div>
                             <p id="noGraficosMsg" class="text-gray-500 text-center mt-4 hidden">No hay gráficos disponibles para los datos actuales.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-12 py-8 text-center text-sm text-gray-500 border-t border-gray-300">
            <p>&copy; <span id="currentYear"></span> Herramienta de Optimización de Líneas de Producción. Todos los derechos reservados.</p>
            <p class="mt-1">Desarrollado con <i class="fas fa-heart text-red-500"></i> para la eficiencia.</p>
        </footer>
    </div>

<script>
    const API_BASE_URL = '/api/line_balance';

    // --- Elementos del DOM ---
    const unidadesInput = document.getElementById('unidadesProducir');
    const empleadosInput = document.getElementById('empleadosDisponibles');
    const numEstacionesInput = document.getElementById('numEstaciones');
    const btnGenerarCampos = document.getElementById('btnGenerarCamposEstaciones');
    const estacionesContainer = document.getElementById('estacionesInputContainer');
    
    const btnCalcular = document.getElementById('btnCalcularBalanceo');
    const btnExportTXT = document.getElementById('btnExportarTXT');
    const btnExportPDF = document.getElementById('btnExportarPDF');
    
    const resultadosContainer = document.getElementById('resultadosContainer');
    const textoResultadosDiv = document.getElementById('textoResultados');
    
    const graficoPieDiv = document.getElementById('graficoPieContainer');
    const imgPie = document.getElementById('imgGraficoPie');
    const graficoBarrasDiv = document.getElementById('graficoBarrasContainer');
    const imgBarras = document.getElementById('imgGraficoBarras');
    const noGraficosMsg = document.getElementById('noGraficosMsg');
    
    const tablaCPMContainer = document.getElementById('tablaCPMContainer');
    const tablaCPMBody = document.getElementById('tablaCPMBody');

    const infoModal = document.getElementById('infoModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    
    const loadingModal = document.getElementById('loadingModal');
    const loadingModalTitle = document.getElementById('loadingModalTitle');
    const loadingModalMessage = document.getElementById('loadingModalMessage');

    let fullResultsFromCalculate = null; // Almacenar el objeto de respuesta completo de /calculate

    // --- Funciones del Modal ---
    function showModal(modalId, title, message) {
        const targetModal = document.getElementById(modalId);
        if (!targetModal) return;

        if (modalId === 'infoModal') {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; 
        } else if (modalId === 'loadingModal') {
            loadingModalTitle.textContent = title;
            loadingModalMessage.textContent = message;
        }
        targetModal.style.display = "block";
    }

    function closeModal(modalId) {
        const targetModal = document.getElementById(modalId);
        if (targetModal) {
            targetModal.style.display = "none";
        }
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
    
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // --- Lógica de Pestañas ---
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(item => item.classList.remove('active'));
            tab.classList.add('active');
            const targetTab = tab.getAttribute('data-tab');
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab) {
                    content.classList.add('active');
                }
            });
        });
    });


    // --- Lógica de la Interfaz ---
    btnGenerarCampos.addEventListener('click', () => {
        const numEst = parseInt(numEstacionesInput.value);
        if (isNaN(numEst) || numEst <= 0) {
            showModal("infoModal", "Error de Validación", "Por favor, ingresa un número válido de estaciones (mayor a 0).");
            return;
        }
        if (numEst > 30) { 
            showModal("infoModal", "Advertencia de Límite", "Se recomienda no exceder 30 estaciones para una mejor visualización y rendimiento. Se generarán los campos solicitados, pero considere esta recomendación.");
        }

        estacionesContainer.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-gray-700">Detalles de Estaciones:</h3>`;
        for (let i = 0; i < numEst; i++) {
            const estDiv = document.createElement('div');
            estDiv.className = 'grid grid-cols-1 sm:grid-cols-10 gap-3 items-center p-3 border border-gray-200 rounded-lg shadow-sm bg-white';
            estDiv.innerHTML = `
                <label class="sm:col-span-1 text-sm font-medium text-gray-700">E${i+1}:</label>
                <div class="sm:col-span-3">
                    <input type="text" placeholder="Nombre Estación" class="input-field estacion-nombre-input" required title="Nombre único de la estación">
                </div>
                <div class="sm:col-span-3">
                    <input type="number" placeholder="Tiempo (min)" min="0.01" step="0.01" class="input-field estacion-tiempo-input" required title="Tiempo de proceso en minutos (ej: 2.5)">
                </div>
                <div class="sm:col-span-3">
                    <input type="text" placeholder="Predecesora (Nombre)" class="input-field estacion-predecesora-input" title="Nombre de la estación anterior (opcional, solo un nombre)">
                </div>
            `;
            estacionesContainer.appendChild(estDiv);
        }
    });

    function recolectarDatosEstaciones() {
        const estacionesData = [];
        const nombresInputs = document.querySelectorAll('.estacion-nombre-input');
        const tiemposInputs = document.querySelectorAll('.estacion-tiempo-input');
        const predecesorasInputs = document.querySelectorAll('.estacion-predecesora-input');
        let valido = true;
        const nombresUnicos = new Set();

        if (nombresInputs.length === 0) {
            showModal("infoModal", "Error de Entrada", "No se han generado campos para las estaciones. Por favor, defina el número de estaciones y genere los campos.");
            return null;
        }

        for (let i = 0; i < nombresInputs.length; i++) {
            const nombre = nombresInputs[i].value.trim();
            const tiempoStr = tiemposInputs[i].value.trim();
            const predecesora = predecesorasInputs[i].value.trim(); // Solo un nombre esperado

            if (!nombre) {
                showModal("infoModal", "Error de Entrada", `El nombre para la Estación ${i+1} no puede estar vacío.`);
                nombresInputs[i].focus(); valido = false; break;
            }
            if (nombresUnicos.has(nombre.toLowerCase())) { 
                showModal("infoModal", "Error de Entrada", `Nombre de estación duplicado: '${nombre}'. Los nombres deben ser únicos.`);
                nombresInputs[i].focus(); valido = false; break;
            }
            nombresUnicos.add(nombre.toLowerCase());
            
            const tiempoNum = parseFloat(tiempoStr);
            if (!tiempoStr || isNaN(tiempoNum) || tiempoNum <= 0) {
                showModal("infoModal", "Error de Entrada", `El tiempo para la Estación '${nombre}' debe ser un número positivo (ej: 2, 3.75).`);
                tiemposInputs[i].focus(); valido = false; break;
            }
            estacionesData.push({
                nombre: nombre,
                tiempo: tiempoNum, 
                predecesora: predecesora 
            });
        }
        return valido ? estacionesData : null;
    }

    btnCalcular.addEventListener('click', async () => {
        const unidades = parseInt(unidadesInput.value);
        const empleados = parseInt(empleadosInput.value);
        const estacionesData = recolectarDatosEstaciones();

        if (isNaN(unidades) || unidades < 0) {
            showModal("infoModal", "Error de Validación", "Unidades a producir debe ser un número no negativo."); unidadesInput.focus(); return;
        }
        if (isNaN(empleados) || empleados < 0) {
            showModal("infoModal", "Error de Validación", "Empleados disponibles debe ser un número no negativo."); empleadosInput.focus(); return;
        }
        if (!estacionesData) return; 

        const payload = {
            unidades_a_producir: unidades,
            num_empleados_disponibles: empleados,
            estaciones_data: estacionesData
        };
        
        showModal("loadingModal", "Calculando...", "Procesando los datos, por favor espera.");
        try {
            const response = await fetch(`${API_BASE_URL}/calculate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            closeModal('loadingModal'); 

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `Error HTTP ${response.status}. No se pudo obtener detalle.` }));
                throw new Error(errorData.error || `Error del servidor: ${response.status}`);
            }

            const resultadosCompletos = await response.json(); // Este es el objeto completo
            fullResultsFromCalculate = resultadosCompletos; // Almacenar para exportar

            // Acceder a los resultados calculados anidados
            const calculos = resultadosCompletos.resultados_calculados;
            
            // AJUSTE AQUÍ para acceder al análisis_texto
            textoResultadosDiv.textContent = calculos.analisis_texto || "No se generó análisis detallado.";
            
            let graficosDisponibles = false;
            if (calculos.grafico_pie_url) {
                imgPie.src = `/static/${calculos.grafico_pie_url}?v=${new Date().getTime()}`; 
                graficoPieDiv.classList.remove('hidden');
                graficosDisponibles = true;
            } else {
                graficoPieDiv.classList.add('hidden');
            }
            if (calculos.grafico_barras_url) {
                imgBarras.src = `/static/${calculos.grafico_barras_url}?v=${new Date().getTime()}`; 
                graficoBarrasDiv.classList.remove('hidden');
                graficosDisponibles = true;
            } else {
                graficoBarrasDiv.classList.add('hidden');
            }
            noGraficosMsg.classList.toggle('hidden', graficosDisponibles);


            tablaCPMBody.innerHTML = ''; 
            if (calculos.estaciones_cpm_detalle && calculos.estaciones_cpm_detalle.length > 0) {
                calculos.estaciones_cpm_detalle.forEach(est => {
                    const row = tablaCPMBody.insertRow();
                    row.insertCell().textContent = est.nombre;
                    row.insertCell().textContent = est.tiempo.toFixed(2);
                    row.insertCell().textContent = est.es.toFixed(2);
                    row.insertCell().textContent = est.ef.toFixed(2);
                    row.insertCell().textContent = est.ls.toFixed(2);
                    row.insertCell().textContent = est.lf.toFixed(2);
                    row.insertCell().textContent = est.holgura.toFixed(2);
                    const criticaCell = row.insertCell();
                    criticaCell.textContent = est.es_critica ? 'Sí' : 'No';
                    criticaCell.className = est.es_critica ? 'text-red-600 font-semibold' : 'text-green-600';
                    if(est.es_critica) row.classList.add('bg-red-50');
                });
                tablaCPMContainer.classList.remove('hidden');
            } else {
                tablaCPMContainer.classList.add('hidden');
                 tablaCPMBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-4">No hay datos de CPM para mostrar.</td></tr>';
            }

            resultadosContainer.classList.remove('hidden');
            btnExportTXT.classList.remove('hidden');
            btnExportPDF.classList.remove('hidden');
            showModal("infoModal", "Cálculo Exitoso", resultadosCompletos.mensaje || "El cálculo se completó correctamente. Revise los resultados en las pestañas correspondientes.");

        } catch (error) {
            console.error("Error en cálculo:", error);
            showModal("infoModal", "Error en Cálculo", `Ocurrió un problema: ${error.message}. Por favor, revise los datos de entrada y la consola para más detalles.`);
            resultadosContainer.classList.add('hidden');
            btnExportTXT.classList.add('hidden');
            btnExportPDF.classList.add('hidden');
            fullResultsFromCalculate = null; // Resetear en caso de error
        }
    });

    // --- Funciones de Exportación ---
    async function exportReport(format) {
        if (!fullResultsFromCalculate) { // Usar la variable que almacena el objeto completo
            showModal("infoModal", "Error de Exportación", "No hay datos calculados para exportar. Por favor, realiza un cálculo primero.");
            return;
        }
        showModal("loadingModal", "Exportando...", `Generando reporte en formato ${format.toUpperCase()}, por favor espera.`);
        try {
            // Enviar el objeto completo almacenado
            const response = await fetch(`${API_BASE_URL}/report/${format}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(fullResultsFromCalculate) 
            });

            closeModal('loadingModal'); 

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `Error HTTP ${response.status}. No se pudo obtener detalle.` }));
                throw new Error(errorData.error || `Error del servidor al generar reporte ${format.toUpperCase()}`);
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `reporte_balanceo_linea_productiva.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showModal("infoModal", "Exportación Exitosa", `El reporte en formato ${format.toUpperCase()} se ha descargado correctamente.`);

        } catch (error) {
            console.error(`Error al exportar ${format.toUpperCase()}:`, error);
            showModal("infoModal", `Error al Exportar ${format.toUpperCase()}`, `Ocurrió un problema: ${error.message}.`);
        }
    }

    btnExportTXT.addEventListener('click', () => exportReport('txt'));
    btnExportPDF.addEventListener('click', () => exportReport('pdf'));
    
    if (parseInt(numEstacionesInput.value) > 0) {
        btnGenerarCampos.click();
    }

</script>
</body>
</html>